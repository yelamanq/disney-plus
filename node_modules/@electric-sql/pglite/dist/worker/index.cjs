"use strict";var ue=Object.defineProperty;var Ge=Object.getOwnPropertyDescriptor;var Ve=Object.getOwnPropertyNames;var Qe=Object.prototype.hasOwnProperty;var De=e=>{throw TypeError(e)};var qe=(e,r)=>{for(var t in r)ue(e,t,{get:r[t],enumerable:!0})},ze=(e,r,t,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let a of Ve(r))!Qe.call(e,a)&&a!==t&&ue(e,a,{get:()=>r[a],enumerable:!(n=Ge(r,a))||n.enumerable});return e};var $e=e=>ze(ue({},"__esModule",{value:!0}),e);var pe=(e,r,t)=>r.has(e)||De("Cannot "+t);var i=(e,r,t)=>(pe(e,r,"read from private field"),t?t.call(e):r.get(e)),p=(e,r,t)=>r.has(e)?De("Cannot add the same private member more than once"):r instanceof WeakSet?r.add(e):r.set(e,t),d=(e,r,t,n)=>(pe(e,r,"write to private field"),n?n.call(e,t):r.set(e,t),t),o=(e,r,t)=>(pe(e,r,"access private method"),t);var de=(e,r,t,n)=>({set _(a){d(e,r,a,t)},get _(){return i(e,r,n)}});var Vt={};qe(Vt,{LeaderChangedError:()=>ce,PGliteWorker:()=>Re,worker:()=>Wt});module.exports=$e(Vt);var je=()=>typeof document>"u"?new URL(`file:${__filename}`).href:document.currentScript&&document.currentScript.src||new URL("main.js",document.baseURI).href,P=je();var Se={part:"part",container:"container"};function te(e,r,...t){let n=e.length-1,a=t.length-1;if(a!==-1){if(a===0){e[n]=e[n]+t[0]+r;return}e[n]=e[n]+t[0],e.push(...t.slice(1,a)),e.push(t[a]+r)}}function He(e,...r){let t=[e[0]];t.raw=[e.raw[0]];let n=[];for(let a=0;a<r.length;a++){let s=r[a],c=a+1;if(s?._templateType===Se.part){te(t,e[c],s.str),te(t.raw,e.raw[c],s.str);continue}if(s?._templateType===Se.container){te(t,e[c],...s.strings),te(t.raw,e.raw[c],...s.strings.raw),n.push(...s.values);continue}t.push(e[c]),t.raw.push(e.raw[c]),n.push(s)}return{_templateType:"container",strings:t,values:n}}function ye(e,...r){let{strings:t,values:n}=He(e,...r);return{query:[t[0],...n.flatMap((a,s)=>[`$${s+1}`,t[s+1]])].join(""),params:n}}var Ye=globalThis.JSON.parse,Ke=globalThis.JSON.stringify,Ie=16,Me=17;var ke=20,Je=21,Xe=23;var fe=25,Ze=26;var Le=114;var et=700,tt=701;var rt=1042,nt=1043,st=1082;var it=1114,Ce=1184;var at=3802;var ot={string:{to:fe,from:[fe,nt,rt],serialize:e=>{if(typeof e=="string")return e;if(typeof e=="number")return e.toString();throw new Error("Invalid input for string type")},parse:e=>e},number:{to:0,from:[Je,Xe,Ze,et,tt],serialize:e=>e.toString(),parse:e=>+e},bigint:{to:ke,from:[ke],serialize:e=>e.toString(),parse:e=>{let r=BigInt(e);return r<Number.MIN_SAFE_INTEGER||r>Number.MAX_SAFE_INTEGER?r:Number(r)}},json:{to:Le,from:[Le,at],serialize:e=>typeof e=="string"?e:Ke(e),parse:e=>Ye(e)},boolean:{to:Ie,from:[Ie],serialize:e=>{if(typeof e!="boolean")throw new Error("Invalid input for boolean type");return e?"t":"f"},parse:e=>e==="t"},date:{to:Ce,from:[st,it,Ce],serialize:e=>{if(typeof e=="string")return e;if(typeof e=="number")return new Date(e).toISOString();if(e instanceof Date)return e.toISOString();throw new Error("Invalid input for date type")},parse:e=>new Date(e)},bytea:{to:Me,from:[Me],serialize:e=>{if(!(e instanceof Uint8Array))throw new Error("Invalid input for bytea type");return"\\x"+Array.from(e).map(r=>r.toString(16).padStart(2,"0")).join("")},parse:e=>{let r=e.slice(2);return Uint8Array.from({length:r.length/2},(t,n)=>parseInt(r.substring(n*2,(n+1)*2),16))}}},he=ct(ot),ve=he.parsers,Oe=he.serializers;function ge(e,r,t){if(e===null)return null;let n=t?.[r]??he.parsers[r];return n?n(e,r):e}function ct(e){return Object.keys(e).reduce(({parsers:r,serializers:t},n)=>{let{to:a,from:s,serialize:c,parse:u}=e[n];return t[a]=c,t[n]=c,r[n]=u,Array.isArray(s)?s.forEach(l=>{r[l]=u,t[l]=c}):(r[s]=u,t[s]=c),{parsers:r,serializers:t}},{parsers:{},serializers:{}})}var lt=/\\/g,ut=/"/g;function pt(e){return e.replace(lt,"\\\\").replace(ut,'\\"')}function be(e,r,t){if(Array.isArray(e)===!1)return e;if(!e.length)return"{}";let n=e[0],a=t===1020?";":",";return Array.isArray(n)?`{${e.map(s=>be(s,r,t)).join(a)}}`:`{${e.map(s=>(s===void 0&&(s=null),s===null?"null":'"'+pt(r?r(s):s.toString())+'"')).join(a)}}`}var me={i:0,char:null,str:"",quoted:!1,last:0,p:null};function Ue(e,r,t){return me.i=me.last=0,Ne(me,e,r,t)[0]}function Ne(e,r,t,n){let a=[],s=n===1020?";":",";for(;e.i<r.length;e.i++){if(e.char=r[e.i],e.quoted)e.char==="\\"?e.str+=r[++e.i]:e.char==='"'?(a.push(t?t(e.str):e.str),e.str="",e.quoted=r[e.i+1]==='"',e.last=e.i+2):e.str+=e.char;else if(e.char==='"')e.quoted=!0;else if(e.char==="{")e.last=++e.i,a.push(Ne(e,r,t,n));else if(e.char==="}"){e.quoted=!1,e.last<e.i&&a.push(t?t(r.slice(e.last,e.i)):r.slice(e.last,e.i)),e.last=e.i+1;break}else e.char===s&&e.p!=="}"&&e.p!=='"'&&(a.push(t?t(r.slice(e.last,e.i)):r.slice(e.last,e.i)),e.last=e.i+1);e.p=e.char}return e.last<e.i&&a.push(t?t(r.slice(e.last,e.i+1)):r.slice(e.last,e.i+1)),a}function we(e,r,t,n){let a=[],s={rows:[],fields:[]},c=0,u={...r,...t?.parsers},l=e.filter(y=>y.name==="rowDescription"||y.name==="dataRow"||y.name==="commandComplete");return l.forEach((y,f)=>{if(y.name==="rowDescription"){let A=y;s.fields=A.fields.map(b=>({name:b.name,dataTypeID:b.dataTypeID}))}else if(y.name==="dataRow"&&s){let A=y;t?.rowMode==="array"?s.rows.push(A.fields.map((b,L)=>ge(b,s.fields[L].dataTypeID,u))):s.rows.push(Object.fromEntries(A.fields.map((b,L)=>[s.fields[L].name,ge(b,s.fields[L].dataTypeID,u)])))}else y.name==="commandComplete"&&(c+=dt(y),f===l.length-1?a.push({...s,affectedRows:c,...n?{blob:n}:{}}):a.push(s),s={rows:[],fields:[]})}),a.length===0&&a.push({rows:[],fields:[]}),a}function dt(e){let r=e.text.split(" ");switch(r[0]){case"INSERT":return parseInt(r[2],10);case"UPDATE":case"DELETE":return parseInt(r[1],10);default:return 0}}function xe(e){let r=e.find(t=>t.name==="parameterDescription");return r?r.dataTypeIDs:[]}function W(e){let r=e.length;for(let t=e.length-1;t>=0;t--){let n=e.charCodeAt(t);n>127&&n<=2047?r++:n>2047&&n<=65535&&(r+=2),n>=56320&&n<=57343&&t--}return r}var w,x,G,ne,V,T,re,F,_e,C=class{constructor(r=256){this.size=r;p(this,T);p(this,w);p(this,x,5);p(this,G,!1);p(this,ne,new TextEncoder);p(this,V,0);d(this,w,o(this,T,re).call(this,r))}addInt32(r){return o(this,T,F).call(this,4),i(this,w).setInt32(i(this,x),r,i(this,G)),d(this,x,i(this,x)+4),this}addInt16(r){return o(this,T,F).call(this,2),i(this,w).setInt16(i(this,x),r,i(this,G)),d(this,x,i(this,x)+2),this}addCString(r){return r&&this.addString(r),o(this,T,F).call(this,1),i(this,w).setUint8(i(this,x),0),de(this,x)._++,this}addString(r=""){let t=W(r);return o(this,T,F).call(this,t),i(this,ne).encodeInto(r,new Uint8Array(i(this,w).buffer,i(this,x))),d(this,x,i(this,x)+t),this}add(r){return o(this,T,F).call(this,r.byteLength),new Uint8Array(i(this,w).buffer).set(new Uint8Array(r),i(this,x)),d(this,x,i(this,x)+r.byteLength),this}flush(r){let t=o(this,T,_e).call(this,r);return d(this,x,5),d(this,w,o(this,T,re).call(this,this.size)),new Uint8Array(t)}};w=new WeakMap,x=new WeakMap,G=new WeakMap,ne=new WeakMap,V=new WeakMap,T=new WeakSet,re=function(r){return new DataView(new ArrayBuffer(r))},F=function(r){if(i(this,w).byteLength-i(this,x)<r){let n=i(this,w).buffer,a=n.byteLength+(n.byteLength>>1)+r;d(this,w,o(this,T,re).call(this,a)),new Uint8Array(i(this,w).buffer).set(new Uint8Array(n))}},_e=function(r){if(r){i(this,w).setUint8(i(this,V),r);let t=i(this,x)-(i(this,V)+1);i(this,w).setInt32(i(this,V)+1,t,i(this,G))}return i(this,w).buffer.slice(r?0:5,i(this,x))};var h=new C,yt=e=>{h.addInt16(3).addInt16(0);for(let n of Object.keys(e))h.addCString(n).addCString(e[n]);h.addCString("client_encoding").addCString("UTF8");let r=h.addCString("").flush(),t=r.byteLength+4;return new C().addInt32(t).add(r).flush()},mt=()=>{let e=new DataView(new ArrayBuffer(8));return e.setInt32(0,8,!1),e.setInt32(4,80877103,!1),new Uint8Array(e.buffer)},ft=e=>h.addCString(e).flush(112),ht=(e,r)=>(h.addCString(e).addInt32(W(r)).addString(r),h.flush(112)),gt=e=>h.addString(e).flush(112),bt=e=>h.addCString(e).flush(81),wt=[],xt=e=>{let r=e.name??"";r.length>63&&(console.error("Warning! Postgres only supports 63 characters for query names."),console.error("You supplied %s (%s)",r,r.length),console.error("This can cause conflicts and silent errors executing queries"));let t=h.addCString(r).addCString(e.text).addInt16(e.types?.length??0);return e.types?.forEach(n=>t.addInt32(n)),h.flush(80)},Q=new C;var At=(e,r)=>{for(let t=0;t<e.length;t++){let n=r?r(e[t],t):e[t];if(n===null)h.addInt16(0),Q.addInt32(-1);else if(n instanceof ArrayBuffer||ArrayBuffer.isView(n)){let a=ArrayBuffer.isView(n)?n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength):n;h.addInt16(1),Q.addInt32(a.byteLength),Q.add(a)}else h.addInt16(0),Q.addInt32(W(n)),Q.addString(n)}},Pt=(e={})=>{let r=e.portal??"",t=e.statement??"",n=e.binary??!1,a=e.values??wt,s=a.length;return h.addCString(r).addCString(t),h.addInt16(s),At(a,e.valueMapper),h.addInt16(s),h.add(Q.flush()),h.addInt16(n?1:0),h.flush(66)},Tt=new Uint8Array([69,0,0,0,9,0,0,0,0,0]),Rt=e=>{if(!e||!e.portal&&!e.rows)return Tt;let r=e.portal??"",t=e.rows??0,n=W(r),a=4+n+1+4,s=new DataView(new ArrayBuffer(1+a));return s.setUint8(0,69),s.setInt32(1,a,!1),new TextEncoder().encodeInto(r,new Uint8Array(s.buffer,5)),s.setUint8(n+5,0),s.setUint32(s.byteLength-4,t,!1),new Uint8Array(s.buffer)},Et=(e,r)=>{let t=new DataView(new ArrayBuffer(16));return t.setInt32(0,16,!1),t.setInt16(4,1234,!1),t.setInt16(6,5678,!1),t.setInt32(8,e,!1),t.setInt32(12,r,!1),new Uint8Array(t.buffer)},Ae=(e,r)=>{let t=new C;return t.addCString(r),t.flush(e)},Bt=h.addCString("P").flush(68),Dt=h.addCString("S").flush(68),St=e=>e.name?Ae(68,`${e.type}${e.name??""}`):e.type==="P"?Bt:Dt,It=e=>{let r=`${e.type}${e.name??""}`;return Ae(67,r)},Mt=e=>h.add(e).flush(100),kt=e=>Ae(102,e),se=e=>new Uint8Array([e,0,0,0,4]),Lt=se(72),Ct=se(83),vt=se(88),Ot=se(99),R={startup:yt,password:ft,requestSsl:mt,sendSASLInitialResponseMessage:ht,sendSCRAMClientFinalMessage:gt,query:bt,parse:xt,bind:Pt,execute:Rt,describe:St,close:It,flush:()=>Lt,sync:()=>Ct,end:()=>vt,copyData:Mt,copyDone:()=>Ot,copyFail:kt,cancel:Et};var pr=new ArrayBuffer(0);var Nt=1,_t=4,Jr=Nt+_t,Xr=new ArrayBuffer(0);var $,k,m,B,ie,v,Pe,ae=class{constructor(){p(this,m);this.serializers={...Oe};this.parsers={...ve};p(this,$,!1);p(this,k,!1)}async _initArrayTypes(){if(i(this,$))return;d(this,$,!0);let r=await this.query(`
      SELECT b.oid, b.typarray
      FROM pg_catalog.pg_type a
      LEFT JOIN pg_catalog.pg_type b ON b.oid = a.typelem
      WHERE a.typcategory = 'A'
      GROUP BY b.oid, b.typarray
      ORDER BY b.oid
    `);for(let t of r.rows)this.serializers[t.typarray]=n=>be(n,this.serializers[t.oid],t.typarray),this.parsers[t.typarray]=n=>Ue(n,this.parsers[t.oid],t.typarray)}async query(r,t,n){return await this._checkReady(),await this._runExclusiveTransaction(async()=>await o(this,m,ie).call(this,r,t,n))}async sql(r,...t){let{query:n,params:a}=ye(r,...t);return await this.query(n,a)}async exec(r,t){return await this._checkReady(),await this._runExclusiveTransaction(async()=>await o(this,m,v).call(this,r,t))}async describeQuery(r,t){try{await o(this,m,B).call(this,R.parse({text:r,types:t?.paramTypes}),t);let n=await o(this,m,B).call(this,R.describe({type:"S"}),t),a=n.messages.find(l=>l.name==="parameterDescription"),s=n.messages.find(l=>l.name==="rowDescription"),c=a?.dataTypeIDs.map(l=>({dataTypeID:l,serializer:this.serializers[l]}))??[],u=s?.fields.map(l=>({name:l.name,dataTypeID:l.dataTypeID,parser:this.parsers[l.dataTypeID]}))??[];return{queryParams:c,resultFields:u}}finally{await o(this,m,B).call(this,R.sync(),t)}}async transaction(r){return await this._checkReady(),await this._runExclusiveTransaction(async()=>{await o(this,m,v).call(this,"BEGIN"),d(this,k,!0);let t=!1,n=()=>{if(t)throw new Error("Transaction is closed")},a={query:async(s,c,u)=>(n(),await o(this,m,ie).call(this,s,c,u)),sql:async(s,...c)=>{let{query:u,params:l}=ye(s,...c);return await o(this,m,ie).call(this,u,l)},exec:async(s,c)=>(n(),await o(this,m,v).call(this,s,c)),rollback:async()=>{n(),await o(this,m,v).call(this,"ROLLBACK"),t=!0},get closed(){return t}};try{let s=await r(a);return t||(t=!0,await o(this,m,v).call(this,"COMMIT")),d(this,k,!1),s}catch(s){throw t||await o(this,m,v).call(this,"ROLLBACK"),d(this,k,!1),s}})}async runExclusive(r){return await this._runExclusiveQuery(r)}};$=new WeakMap,k=new WeakMap,m=new WeakSet,B=async function(r,t={}){return await this.execProtocol(r,{...t,syncToFs:!1})},ie=async function(r,t=[],n){return await this._runExclusiveQuery(async()=>{o(this,m,Pe).call(this,"runQuery",r,t,n),await this._handleBlob(n?.blob);let a;try{let{messages:c}=await o(this,m,B).call(this,R.parse({text:r,types:n?.paramTypes}),n),u=xe((await o(this,m,B).call(this,R.describe({type:"S"}),n)).messages),l=t.map((y,f)=>{let A=u[f];if(y==null)return null;let b=n?.serializers?.[A]??this.serializers[A];return b?b(y):y.toString()});a=[...c,...(await o(this,m,B).call(this,R.bind({values:l}),n)).messages,...(await o(this,m,B).call(this,R.describe({type:"P"}),n)).messages,...(await o(this,m,B).call(this,R.execute({}),n)).messages]}finally{await o(this,m,B).call(this,R.sync(),n)}await this._cleanupBlob(),i(this,k)||await this.syncToFs();let s=await this._getWrittenBlob();return we(a,this.parsers,n,s)[0]})},v=async function(r,t){return await this._runExclusiveQuery(async()=>{o(this,m,Pe).call(this,"runExec",r,t),await this._handleBlob(t?.blob);let n;try{n=(await o(this,m,B).call(this,R.query(r),t)).messages}finally{await o(this,m,B).call(this,R.sync(),t)}this._cleanupBlob(),i(this,k)||await this.syncToFs();let a=await this._getWrittenBlob();return we(n,this.parsers,t,a)})},Pe=function(...r){this.debug>0&&console.log(...r)};var bn=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string";var Te=()=>{if(globalThis.crypto?.randomUUID)return globalThis.crypto.randomUUID();let e=new Uint8Array(16);if(globalThis.crypto?.getRandomValues)globalThis.crypto.getRandomValues(e);else for(let t=0;t<e.length;t++)e[t]=Math.floor(Math.random()*256);e[6]=e[6]&15|64,e[8]=e[8]&63|128;let r=[];return e.forEach(t=>{r.push(t.toString(16).padStart(2,"0"))}),r.slice(0,4).join("")+"-"+r.slice(4,6).join("")+"-"+r.slice(6,8).join("")+"-"+r.slice(8,10).join("")+"-"+r.slice(10).join("")};var q,j,H,z,Y,D,O,U,S,K,J,X,N,M,Z,I,_,ee,le,g,We,oe,E,Fe,Be=class Be extends ae{constructor(t,n){super();p(this,g);p(this,q);p(this,j,0);p(this,H,!1);p(this,z,!1);p(this,Y,!1);p(this,D,new EventTarget);p(this,O);p(this,U,!1);p(this,S);p(this,K);p(this,J);p(this,X);p(this,N);p(this,M);p(this,Z);p(this,I,new Map);p(this,_,new Set);p(this,ee);p(this,le,[]);d(this,S,t),d(this,O,Te()),d(this,ee,n?.extensions??{}),d(this,J,new Promise(a=>{i(this,S).addEventListener("message",s=>{if(s.data.type==="here")a();else throw new Error("Invalid message")},{once:!0})})),d(this,X,new Promise(a=>{let s=c=>{c.data.type==="ready"&&(d(this,K,c.data.id),i(this,S).removeEventListener("message",s),a())};i(this,S).addEventListener("message",s)})),d(this,q,o(this,g,We).call(this,n))}static async create(t,n){let a=new Be(t,n);return await i(a,q),a}get waitReady(){return new Promise(t=>{i(this,q).then(()=>{i(this,U)?t():t(new Promise(n=>{i(this,D).addEventListener("connected",()=>{n()})}))})})}get debug(){return i(this,j)}get ready(){return i(this,H)}get closed(){return i(this,z)}get isLeader(){return i(this,Y)}async close(){var t;i(this,z)||(d(this,z,!0),i(this,N)?.close(),i(this,M)?.close(),(t=i(this,Z))==null||t.call(this),i(this,S).terminate())}async[Symbol.asyncDispose](){await this.close()}async execProtocolRaw(t){return await o(this,g,E).call(this,"execProtocolRaw",t)}async execProtocol(t){return await o(this,g,E).call(this,"execProtocol",t)}async syncToFs(){await o(this,g,E).call(this,"syncToFs")}async listen(t,n){return await this.waitReady,i(this,I).has(t)||i(this,I).set(t,new Set),i(this,I).get(t)?.add(n),await this.exec(`LISTEN ${t}`),async()=>{await this.unlisten(t,n)}}async unlisten(t,n){await this.waitReady,n?i(this,I).get(t)?.delete(n):i(this,I).delete(t),i(this,I).get(t)?.size===0&&await this.exec(`UNLISTEN ${t}`)}onNotification(t){return i(this,_).add(t),()=>{i(this,_).delete(t)}}offNotification(t){i(this,_).delete(t)}async dumpDataDir(){return await o(this,g,E).call(this,"dumpDataDir")}onLeaderChange(t){return i(this,D).addEventListener("leader-change",t),()=>{i(this,D).removeEventListener("leader-change",t)}}offLeaderChange(t){i(this,D).removeEventListener("leader-change",t)}async _handleBlob(t){await o(this,g,E).call(this,"_handleBlob",t)}async _getWrittenBlob(){return await o(this,g,E).call(this,"_getWrittenBlob")}async _cleanupBlob(){await o(this,g,E).call(this,"_cleanupBlob")}async _checkReady(){await this.waitReady}async _runExclusiveQuery(t){await o(this,g,E).call(this,"_acquireQueryLock");try{return await t()}finally{await o(this,g,E).call(this,"_releaseQueryLock")}}async _runExclusiveTransaction(t){await o(this,g,E).call(this,"_acquireTransactionLock");try{return await t()}finally{await o(this,g,E).call(this,"_releaseTransactionLock")}}};q=new WeakMap,j=new WeakMap,H=new WeakMap,z=new WeakMap,Y=new WeakMap,D=new WeakMap,O=new WeakMap,U=new WeakMap,S=new WeakMap,K=new WeakMap,J=new WeakMap,X=new WeakMap,N=new WeakMap,M=new WeakMap,Z=new WeakMap,I=new WeakMap,_=new WeakMap,ee=new WeakMap,le=new WeakMap,g=new WeakSet,We=async function(t={}){for(let[l,y]of Object.entries(i(this,ee))){if(y instanceof URL)throw new Error("URL extensions are not supported on the client side of a worker");{let f=await y.setup(this,{},!0);if(f.emscriptenOpts&&console.warn(`PGlite extension ${l} returned emscriptenOpts, these are not supported on the client side of a worker`),f.namespaceObj){let A=this;A[l]=f.namespaceObj}f.bundlePath&&console.warn(`PGlite extension ${l} returned bundlePath, this is not supported on the client side of a worker`),f.init&&await f.init(),f.close&&i(this,le).push(f.close)}}await i(this,J);let{extensions:n,...a}=t;i(this,S).postMessage({type:"init",options:a}),await i(this,X);let s=`pglite-tab-close:${i(this,O)}`;d(this,Z,await Ee(s));let c=`pglite-broadcast:${i(this,K)}`;d(this,N,new BroadcastChannel(c));let u=`pglite-tab:${i(this,O)}`;d(this,M,new BroadcastChannel(u)),i(this,N).addEventListener("message",async l=>{l.data.type==="leader-here"?(d(this,U,!1),i(this,D).dispatchEvent(new Event("leader-change")),o(this,g,oe).call(this)):l.data.type==="notify"&&o(this,g,Fe).call(this,l.data.channel,l.data.payload)}),i(this,M).addEventListener("message",async l=>{l.data.type==="connected"&&(d(this,U,!0),i(this,D).dispatchEvent(new Event("connected")),d(this,j,await o(this,g,E).call(this,"getDebugLevel")),d(this,H,!0))}),i(this,S).addEventListener("message",async l=>{l.data.type==="leader-now"&&(d(this,Y,!0),i(this,D).dispatchEvent(new Event("leader-change")))}),o(this,g,oe).call(this),this._initArrayTypes()},oe=async function(){i(this,U)||(i(this,N).postMessage({type:"tab-here",id:i(this,O)}),setTimeout(()=>o(this,g,oe).call(this),16))},E=async function(t,...n){let a=Te(),s={type:"rpc-call",callId:a,method:t,args:n};return i(this,M).postMessage(s),await new Promise((c,u)=>{let l=A=>{if(A.data.callId!==a)return;f();let b=A.data;if(b.type==="rpc-return")c(b.result);else if(b.type==="rpc-error"){let L=new Error(b.error.message);Object.assign(L,b.error),u(L)}else u(new Error("Invalid message"))},y=()=>{f(),u(new ce)},f=()=>{i(this,M).removeEventListener("message",l),i(this,D).removeEventListener("leader-change",y)};i(this,D).addEventListener("leader-change",y),i(this,M).addEventListener("message",l)})},Fe=function(t,n){let a=i(this,I).get(t);if(a)for(let s of a)queueMicrotask(()=>s(n));for(let s of i(this,_))queueMicrotask(()=>s(t,n))};var Re=Be;async function Wt({init:e}){postMessage({type:"here"});let r=await new Promise(y=>{addEventListener("message",f=>{f.data.type==="init"&&y(f.data.options)},{once:!0})}),t=r.id??`${P}:${r.dataDir??""}`;postMessage({type:"ready",id:t});let n=`pglite-election-lock:${t}`,a=`pglite-broadcast:${t}`,s=new BroadcastChannel(a),c=new Set;await Ee(n);let u=e(r);s.onmessage=async y=>{let f=y.data;switch(f.type){case"tab-here":Ft(f.id,await u,c);break}},s.postMessage({type:"leader-here",id:t}),postMessage({type:"leader-now"}),(await u).onNotification((y,f)=>{s.postMessage({type:"notify",channel:y,payload:f})})}function Ft(e,r,t){if(t.has(e))return;t.add(e);let n=`pglite-tab:${e}`,a=`pglite-tab-close:${e}`,s=new BroadcastChannel(n);navigator.locks.request(a,()=>new Promise(u=>{s.close(),t.delete(e),u()}));let c=Gt(e,r);s.addEventListener("message",async u=>{let l=u.data;switch(l.type){case"rpc-call":{await r.waitReady;let{callId:y,method:f,args:A}=l;try{let b=await c[f](...A);s.postMessage({type:"rpc-return",callId:y,result:b})}catch(b){console.error(b),s.postMessage({type:"rpc-error",callId:y,error:{message:b.message}})}break}}}),s.postMessage({type:"connected"})}function Gt(e,r){let t=null,n=null,a=`pglite-tab-close:${e}`;return Ee(a).then(()=>{n&&r.exec("ROLLBACK"),t?.(),n?.()}),{async getDebugLevel(){return r.debug},async close(){await r.close()},async execProtocol(s){let{messages:c,data:u}=await r.execProtocol(s);if(u.byteLength!==u.buffer.byteLength){let l=new ArrayBuffer(u.byteLength),y=new Uint8Array(l);return y.set(u),{messages:c,data:y}}else return{messages:c,data:u}},async execProtocolRaw(s){let c=await r.execProtocolRaw(s);if(c.byteLength!==c.buffer.byteLength){let u=new ArrayBuffer(c.byteLength),l=new Uint8Array(u);return l.set(c),l}else return c},async dumpDataDir(){return await r.dumpDataDir()},async syncToFs(){return await r.syncToFs()},async _handleBlob(s){return await r._handleBlob(s)},async _getWrittenBlob(){return await r._getWrittenBlob()},async _cleanupBlob(){return await r._cleanupBlob()},async _checkReady(){return await r._checkReady()},async _acquireQueryLock(){return new Promise(s=>{r._runExclusiveQuery(()=>new Promise(c=>{t=c,s()}))})},async _releaseQueryLock(){t?.(),t=null},async _acquireTransactionLock(){return new Promise(s=>{r._runExclusiveTransaction(()=>new Promise(c=>{n=c,s()}))})},async _releaseTransactionLock(){n?.(),n=null}}}var ce=class extends Error{constructor(){super("Leader changed, pending operation in indeterminate state")}};async function Ee(e){let r;return await new Promise(t=>{navigator.locks.request(e,()=>new Promise(n=>{r=n,t()}))}),r}0&&(module.exports={LeaderChangedError,PGliteWorker,worker});
//# sourceMappingURL=index.cjs.map