import{a as O,b as D,c as Q,d as v,f as R,g as z,i as c}from"./chunk-5L6BPGXX.js";import{d as g}from"./chunk-STOZMFXW.js";import{e as P,f as w,g as p,h as a,j as _}from"./chunk-BTBUZ646.js";_();var b,u,r,o,d,h,f,B=class{constructor(){w(this,r);this.serializers={...D};this.parsers={...O};w(this,b,!1);w(this,u,!1)}async _initArrayTypes(){if(P(this,b))return;p(this,b,!0);let t=await this.query(`
      SELECT b.oid, b.typarray
      FROM pg_catalog.pg_type a
      LEFT JOIN pg_catalog.pg_type b ON b.oid = a.typelem
      WHERE a.typcategory = 'A'
      GROUP BY b.oid, b.typarray
      ORDER BY b.oid
    `);for(let s of t.rows)this.serializers[s.typarray]=e=>Q(e,this.serializers[s.oid],s.typarray),this.parsers[s.typarray]=e=>v(e,this.parsers[s.oid],s.typarray)}async query(t,s,e){return await this._checkReady(),await this._runExclusiveTransaction(async()=>await a(this,r,d).call(this,t,s,e))}async sql(t,...s){let{query:e,params:l}=g(t,...s);return await this.query(e,l)}async exec(t,s){return await this._checkReady(),await this._runExclusiveTransaction(async()=>await a(this,r,h).call(this,t,s))}async describeQuery(t,s){try{await a(this,r,o).call(this,c.parse({text:t,types:s?.paramTypes}),s);let e=await a(this,r,o).call(this,c.describe({type:"S"}),s),l=e.messages.find(i=>i.name==="parameterDescription"),n=e.messages.find(i=>i.name==="rowDescription"),y=l?.dataTypeIDs.map(i=>({dataTypeID:i,serializer:this.serializers[i]}))??[],m=n?.fields.map(i=>({name:i.name,dataTypeID:i.dataTypeID,parser:this.parsers[i.dataTypeID]}))??[];return{queryParams:y,resultFields:m}}finally{await a(this,r,o).call(this,c.sync(),s)}}async transaction(t){return await this._checkReady(),await this._runExclusiveTransaction(async()=>{await a(this,r,h).call(this,"BEGIN"),p(this,u,!0);let s=!1,e=()=>{if(s)throw new Error("Transaction is closed")},l={query:async(n,y,m)=>(e(),await a(this,r,d).call(this,n,y,m)),sql:async(n,...y)=>{let{query:m,params:i}=g(n,...y);return await a(this,r,d).call(this,m,i)},exec:async(n,y)=>(e(),await a(this,r,h).call(this,n,y)),rollback:async()=>{e(),await a(this,r,h).call(this,"ROLLBACK"),s=!0},get closed(){return s}};try{let n=await t(l);return s||(s=!0,await a(this,r,h).call(this,"COMMIT")),p(this,u,!1),n}catch(n){throw s||await a(this,r,h).call(this,"ROLLBACK"),p(this,u,!1),n}})}async runExclusive(t){return await this._runExclusiveQuery(t)}};b=new WeakMap,u=new WeakMap,r=new WeakSet,o=async function(t,s={}){return await this.execProtocol(t,{...s,syncToFs:!1})},d=async function(t,s=[],e){return await this._runExclusiveQuery(async()=>{a(this,r,f).call(this,"runQuery",t,s,e),await this._handleBlob(e?.blob);let l;try{let{messages:y}=await a(this,r,o).call(this,c.parse({text:t,types:e?.paramTypes}),e),m=z((await a(this,r,o).call(this,c.describe({type:"S"}),e)).messages),i=s.map((T,A)=>{let x=m[A];if(T==null)return null;let E=e?.serializers?.[x]??this.serializers[x];return E?E(T):T.toString()});l=[...y,...(await a(this,r,o).call(this,c.bind({values:i}),e)).messages,...(await a(this,r,o).call(this,c.describe({type:"P"}),e)).messages,...(await a(this,r,o).call(this,c.execute({}),e)).messages]}finally{await a(this,r,o).call(this,c.sync(),e)}await this._cleanupBlob(),P(this,u)||await this.syncToFs();let n=await this._getWrittenBlob();return R(l,this.parsers,e,n)[0]})},h=async function(t,s){return await this._runExclusiveQuery(async()=>{a(this,r,f).call(this,"runExec",t,s),await this._handleBlob(s?.blob);let e;try{e=(await a(this,r,o).call(this,c.query(t),s)).messages}finally{await a(this,r,o).call(this,c.sync(),s)}this._cleanupBlob(),P(this,u)||await this.syncToFs();let l=await this._getWrittenBlob();return R(e,this.parsers,s,l)})},f=function(...t){this.debug>0&&console.log(...t)};export{B as a};
//# sourceMappingURL=chunk-Y4PL6ZOT.js.map